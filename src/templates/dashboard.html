{% extends "base.html" %}

{% block content %}
<div id="pageShell" class="space-y-6">
    <!-- Quick Stats Bar -->
    <div class="mc-card section-grass p-4 grid-pattern">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
                <div class="block-icon mx-auto mb-2">
                    <i class="fas fa-users text-emerald-400 text-xl"></i>
                </div>
                <div class="text-2xl font-bold text-white">{{ players|length }}</div>
                <div class="text-xs text-gray-400">Players Online</div>
            </div>
            <div class="text-center">
                <div class="block-icon mx-auto mb-2">
                    <i class="fas fa-map-marker-alt text-blue-400 text-xl"></i>
                </div>
                <div class="text-2xl font-bold text-white">{{ locations|length }}</div>
                <div class="text-xs text-gray-400">Saved Locations</div>
            </div>
            <div class="text-center">
                <div class="block-icon mx-auto mb-2">
                    <i class="fas fa-box text-purple-400 text-xl"></i>
                </div>
                <div class="text-2xl font-bold text-white">{{ kits|length }}</div>
                <div class="text-xs text-gray-400">Available Kits</div>
            </div>
            <div class="text-center">
                <div class="block-icon mx-auto mb-2">
                    <i class="fas fa-gift text-yellow-400 text-xl"></i>
                </div>
                <div class="text-2xl font-bold text-white">250+</div>
                <div class="text-xs text-gray-400">Items</div>
            </div>
        </div>
    </div>

    <!-- Quick Navigation -->
    <div class="mc-card p-4">
        <div class="flex items-center gap-2 overflow-x-auto pb-2">
            <a href="#items" class="mc-button bg-gradient-to-b from-emerald-600 to-emerald-700 hover:from-emerald-500 hover:to-emerald-600 text-white px-4 py-2 text-sm whitespace-nowrap">
                <i class="fas fa-gift mr-2"></i>Items
            </a>
            <a href="#kits" class="mc-button bg-gradient-to-b from-purple-600 to-purple-700 hover:from-purple-500 hover:to-purple-600 text-white px-4 py-2 text-sm whitespace-nowrap">
                <i class="fas fa-box-open mr-2"></i>Kits
            </a>
            <a href="#commands" class="mc-button bg-gradient-to-b from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white px-4 py-2 text-sm whitespace-nowrap">
                <i class="fas fa-bolt mr-2"></i>Commands
            </a>
            <a href="#teleport" class="mc-button bg-gradient-to-b from-cyan-600 to-cyan-700 hover:from-cyan-500 hover:to-cyan-600 text-white px-4 py-2 text-sm whitespace-nowrap">
                <i class="fas fa-location-arrow mr-2"></i>Teleport
            </a>
            <a href="#villages" class="mc-button bg-gradient-to-b from-orange-600 to-orange-700 hover:from-orange-500 hover:to-orange-600 text-white px-4 py-2 text-sm whitespace-nowrap">
                <i class="fas fa-compass mr-2"></i>Villages
            </a>
            <a href="#locations" class="mc-button bg-gradient-to-b from-teal-600 to-teal-700 hover:from-teal-500 hover:to-teal-600 text-white px-4 py-2 text-sm whitespace-nowrap">
                <i class="fas fa-map-marked-alt mr-2"></i>Locations
            </a>
        </div>
    </div>

    <!-- Quick Actions Panel -->
    <div class="mc-card p-6 grid-pattern">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-white flex items-center gap-3">
                <div class="block-icon">
                    <i class="fas fa-tachometer-alt text-emerald-400"></i>
                </div>
                Quick Actions
            </h2>
            <select id="topPlayerSelect" class="mc-select text-sm">
                {% if players|length == 0 %}
                <option value="">No players</option>
                {% elif players|length == 1 %}
                <option value="{{ players[0] }}" selected>{{ players[0] }}</option>
                {% else %}
                <option value="">Select player</option>
                {% for player in players %}
                <option value="{{ player }}">{{ player }}</option>
                {% endfor %}
                {% endif %}
            </select>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
            <button onclick="setGamemode('gamemode_creative')" class="mc-button bg-gradient-to-b from-indigo-600 to-indigo-700 hover:from-indigo-500 hover:to-indigo-600 text-white p-4 text-center">
                <i class="fas fa-wand-magic-sparkles text-3xl mb-2 block"></i>
                <span class="text-xs font-semibold">Creative</span>
            </button>
            <button onclick="setGamemode('gamemode_survival')" class="mc-button bg-gradient-to-b from-emerald-600 to-emerald-700 hover:from-emerald-500 hover:to-emerald-600 text-white p-4 text-center">
                <i class="fas fa-shield-halved text-3xl mb-2 block"></i>
                <span class="text-xs font-semibold">Survival</span>
            </button>
            <button onclick="quickCommand('heal')" class="mc-button bg-gradient-to-b from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white p-4 text-center">
                <i class="fas fa-heart text-3xl mb-2 block"></i>
                <span class="text-xs font-semibold">Heal</span>
            </button>
            <button onclick="quickCommand('feed')" class="mc-button bg-gradient-to-b from-orange-600 to-orange-700 hover:from-orange-500 hover:to-orange-600 text-white p-4 text-center">
                <i class="fas fa-drumstick-bite text-3xl mb-2 block"></i>
                <span class="text-xs font-semibold">Feed</span>
            </button>
            <button onclick="quickCommand('day')" class="mc-button bg-gradient-to-b from-yellow-600 to-yellow-700 hover:from-yellow-500 hover:to-yellow-600 text-white p-4 text-center">
                <i class="fas fa-sun text-3xl mb-2 block"></i>
                <span class="text-xs font-semibold">Set Day</span>
            </button>
            <button onclick="quickCommand('clear_weather')" class="mc-button bg-gradient-to-b from-sky-600 to-sky-700 hover:from-sky-500 hover:to-sky-600 text-white p-4 text-center">
                <i class="fas fa-cloud-sun text-3xl mb-2 block"></i>
                <span class="text-xs font-semibold">Clear Sky</span>
            </button>
        </div>
    </div>

    <!-- Quick Commands Section -->
    <div id="commands" class="mc-card p-6 grid-pattern">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                <div class="block-icon">
                    <i class="fas fa-bolt text-yellow-400"></i>
                </div>
                Quick Commands
            </h2>
            <select id="quickCommandPlayer" class="mc-select">
                {% if players|length == 0 %}
                <option value="">No players online</option>
                {% elif players|length == 1 %}
                <option value="{{ players[0] }}" selected>{{ players[0] }}</option>
                {% else %}
                <option value="">Select Player</option>
                {% for player in players %}
                <option value="{{ player }}">{{ player }}</option>
                {% endfor %}
                {% endif %}
            </select>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            {% for category in quick_commands %}
            <div class="mc-card p-5 section-{{ category.border_color }}">
                <h3 class="text-lg font-semibold text-{{ category.text_color }}-300 mb-4 flex items-center gap-2">
                    <i class="fas fa-{{ category.category_icon }}"></i>
                    {{ category.name }}
                </h3>
                <div class="grid grid-cols-{{ category.grid_cols }} gap-2">
                    {% for cmd in category.commands %}
                    <button onclick="quickCommand('{{ cmd.id }}')" 
                            class="mc-button bg-gradient-to-b from-{{ cmd.color }}-600 to-{{ cmd.color }}-700 hover:from-{{ cmd.color }}-500 hover:to-{{ cmd.color }}-600 text-white px-4 py-3 text-sm font-medium"
                            title="{{ cmd.description|default('') }}">
                        <i class="fas fa-{{ cmd.icon }} mr-2"></i>{{ cmd.label }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Left Column: Items & Kits -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Give Items Section -->
            <div id="items" class="mc-card p-6 grid-pattern">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                            <div class="block-icon">
                                <i class="fas fa-gift text-yellow-400"></i>
                            </div>
                            Give Items
                        </h2>
                        <div class="px-4 py-2 bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border-2 border-yellow-500/50 text-yellow-200 text-xs font-bold">
                            <i class="fas fa-cube mr-1"></i>250+ Items
                        </div>
                    </div>
                    <p class="text-gray-400 text-sm">Select items and deliver them instantly to players</p>
                </div>

                <form id="giveItemForm" class="space-y-4">
                    <!-- Controls -->
                    <div class="mc-card p-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Search -->
                            <div class="md:col-span-3">
                                <label class="block text-emerald-300 font-semibold mb-2 text-sm">
                                    <i class="fas fa-search mr-2"></i>Search Items
                                </label>
                                <input id="itemFilter" type="text" placeholder="ðŸ” Type to search..." 
                                       class="mc-input w-full text-sm" />
                            </div>
                            
                            <!-- Player -->
                            <div class="md:col-span-2">
                                <label class="block text-emerald-300 font-semibold mb-2 text-sm">
                                    <i class="fas fa-user mr-2"></i>Player
                                </label>
                                <select name="player" required class="mc-select w-full text-sm">
                                    {% if players|length == 0 %}
                                    <option value="">No players online</option>
                                    {% elif players|length == 1 %}
                                    <option value="{{ players[0] }}" selected>{{ players[0] }}</option>
                                    {% else %}
                                    <option value="">Select Player</option>
                                    {% for player in players %}
                                    <option value="{{ player }}">{{ player }}</option>
                                    {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            
                            <!-- Amount -->
                            <div>
                                <label class="block text-emerald-300 font-semibold mb-2 text-sm">
                                    <i class="fas fa-hashtag mr-2"></i>Amount
                                </label>
                                <input type="number" name="amount" value="1" min="1" max="64" 
                                       class="mc-input w-full text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Item Categories -->
                    <div class="space-y-4">
                        {% for category, items_list in items.items() %}
                        <div class="category-block mc-card p-5" 
                             id="cat-{{ category|replace(' ', '-')|lower }}" 
                             data-category="{{ category|lower }}">
                            <!-- Category Header -->
                            <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-700">
                                <h3 class="text-lg font-bold text-emerald-400 flex items-center gap-2">
                                    <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                                    {{ category }}
                                </h3>
                                <span class="px-3 py-1 bg-emerald-500/20 border border-emerald-500/50 text-emerald-300 text-xs font-semibold">
                                    {{ items_list|length }} items
                                </span>
                            </div>
                            
                            <!-- Items Grid -->
                            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                                {% for item in items_list %}
                                <button type="button" 
                                        onclick="giveItem('{{ item.name }}')" 
                                        class="item-btn item-slot p-3 text-center cursor-pointer group relative" 
                                        data-name="{{ item.name }}" 
                                        data-display="{{ item.display }}" 
                                        data-category="{{ category|lower }}">
                                    {% if category == 'Most Used' %}
                                    <div onclick="removeUsage('{{ item.name }}', event)" 
                                         class="absolute -top-1 -right-1 z-20 w-5 h-5 flex items-center justify-center bg-red-600 hover:bg-red-500 opacity-0 group-hover:opacity-100 transition-all cursor-pointer border-2 border-black"
                                         title="Remove from Most Used">
                                        <i class="fas fa-times text-[10px]"></i>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Icon -->
                                    <div class="text-3xl mb-1">{{ item.icon }}</div>
                                    
                                    <!-- Name -->
                                    <div class="text-[10px] text-gray-300 leading-tight line-clamp-2">
                                        {{ item.display }}
                                    </div>
                                    
                                    <!-- Usage Badge -->
                                    {% if item.used_count %}
                                    <div class="absolute -top-1 -left-1 bg-emerald-500 text-white text-[9px] font-bold px-1.5 py-0.5 border-2 border-black">
                                        {{ item.used_count }}Ã—
                                    </div>
                                    {% endif %}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </form>
            </div>

            <!-- Quick Kits Section -->
            <div id="kits" class="mc-card p-6 grid-pattern">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
                    <div class="block-icon">
                        <i class="fas fa-box-open text-purple-400"></i>
                    </div>
                    Quick Kits
                </h2>
                
                <form id="kitForm">
                    <div class="mb-4">
                        <label class="block text-purple-300 font-semibold mb-2 text-sm">
                            <i class="fas fa-user mr-2"></i>Player
                        </label>
                        <select name="player" required class="mc-select w-full">
                            {% if players|length == 0 %}
                            <option value="">No players online</option>
                            {% elif players|length == 1 %}
                            <option value="{{ players[0] }}" selected>{{ players[0] }}</option>
                            {% else %}
                            <option value="">Select Player</option>
                            {% for player in players %}
                            <option value="{{ player }}">{{ player }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        {% for kit in kits %}
                        <button type="button" onclick="giveKit('{{ kit.id }}')" 
                                class="mc-button bg-gradient-to-b from-{{ kit.color }}-600 to-{{ kit.color }}-700 hover:from-{{ kit.color }}-500 hover:to-{{ kit.color }}-600 text-white p-4 text-center"
                                title="{{ kit.description }}">
                            <i class="fas fa-{{ kit.icon }} text-2xl mb-2 block"></i>
                            <div class="text-xs font-semibold">{{ kit.name }}</div>
                        </button>
                        {% endfor %}
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Column: Teleport, Villages & Locations -->
        <div class="space-y-6">
            <!-- Teleport Section -->
            <div id="teleport" class="mc-card p-6 grid-pattern">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
                    <div class="block-icon">
                        <i class="fas fa-location-arrow text-cyan-400"></i>
                    </div>
                    Teleport
                </h2>
                
                <form id="teleportForm" class="space-y-4">
                    <div>
                        <label class="block text-cyan-300 font-semibold mb-2 text-sm">
                            <i class="fas fa-user mr-2"></i>Player
                        </label>
                        <select name="player" required class="mc-select w-full">
                            {% if players|length == 0 %}
                            <option value="">No players online</option>
                            {% elif players|length == 1 %}
                            <option value="{{ players[0] }}" selected>{{ players[0] }}</option>
                            {% else %}
                            <option value="">Select Player</option>
                            {% for player in players %}
                            <option value="{{ player }}">{{ player }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-cyan-300 font-semibold mb-2 text-sm">
                            <i class="fas fa-map-marker-alt mr-2"></i>Preset Locations
                        </label>
                        <div id="locationsList" class="space-y-2"></div>
                    </div>

                    <div class="pt-4 mt-4 border-t border-cyan-800">
                        <label class="block text-cyan-300 font-semibold mb-3 text-sm">
                            <i class="fas fa-crosshairs mr-2"></i>Direct Coordinates
                        </label>
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <input name="x" type="number" placeholder="X" class="mc-input text-sm">
                            <input name="y" type="number" placeholder="Y" class="mc-input text-sm">
                            <input name="z" type="number" placeholder="Z" class="mc-input text-sm">
                        </div>
                        <button type="button" onclick="teleportToCoords()" class="mc-button w-full bg-gradient-to-b from-cyan-600 to-cyan-700 hover:from-cyan-500 hover:to-cyan-600 text-white px-4 py-3 font-semibold">
                            <i class="fas fa-location-crosshairs mr-2"></i>Teleport to Coordinates
                        </button>
                    </div>
                </form>
            </div>

            <!-- Find Villages Section -->
            <div id="villages" class="mc-card p-6 grid-pattern">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
                    <div class="block-icon">
                        <i class="fas fa-compass text-orange-400"></i>
                    </div>
                    Find Villages
                </h2>
                
                <form id="locateForm" class="space-y-4">
                    <div>
                        <label class="block text-orange-300 font-semibold mb-2 text-sm">
                            <i class="fas fa-user mr-2"></i>Player
                        </label>
                        <select name="player" required class="mc-select w-full">
                            {% if players|length == 0 %}
                            <option value="">No players online</option>
                            {% elif players|length == 1 %}
                            <option value="{{ players[0] }}" selected>{{ players[0] }}</option>
                            {% else %}
                            <option value="">Select Player</option>
                            {% for player in players %}
                            <option value="{{ player }}">{{ player }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-orange-300 font-semibold mb-2 text-sm">
                            <i class="fas fa-mountain mr-2"></i>Village Type
                        </label>
                        <div class="grid grid-cols-1 gap-2">
                            {% for vtype in village_types %}
                            <button type="button" onclick="locateVillage('{{ vtype }}')" 
                                    class="mc-button bg-gradient-to-b from-gray-700 to-gray-800 hover:from-orange-600 hover:to-orange-700 text-white px-4 py-3 text-left text-sm">
                                <i class="fas fa-{{ 'tree' if vtype == 'taiga' else 'sun' if vtype == 'desert' else 'cloud-sun' if vtype == 'plains' else 'snowflake' if vtype == 'snowy' else 'leaf' }} mr-2"></i>
                                {{ vtype.title() }} Village
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </form>

                <div id="locationResult" class="mt-4 hidden">
                    <div class="mc-card p-4 bg-emerald-900/30 border-2 border-emerald-500">
                        <p class="text-emerald-200 font-mono text-sm" id="locationText"></p>
                    </div>
                </div>
            </div>

            <!-- Manage Locations Section -->
            <div id="locations" class="mc-card p-6 grid-pattern">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
                    <div class="block-icon">
                        <i class="fas fa-map-marked-alt text-teal-400"></i>
                    </div>
                    Manage Locations
                </h2>

                <!-- Capture Position -->
                <div class="mb-4 mc-card p-4 bg-teal-900/20">
                    <h3 class="text-sm font-semibold text-teal-200 mb-3 flex items-center gap-2">
                        <i class="fas fa-crosshairs"></i>Capture Player Position
                    </h3>
                    <div class="grid grid-cols-1 gap-2">
                        <select id="capturePlayer" class="mc-select text-sm">
                            {% if players|length == 0 %}
                            <option value="">No players online</option>
                            {% else %}
                            <option value="">Select player</option>
                            {% for player in players %}
                            <option value="{{ player }}">{{ player }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                        <input id="captureName" class="mc-input text-sm" placeholder="Location name">
                        <button type="button" onclick="captureAndSaveLocation()" 
                                class="mc-button bg-gradient-to-b from-teal-600 to-teal-700 hover:from-teal-500 hover:to-teal-600 text-white px-4 py-2 font-semibold text-sm">
                            <i class="fas fa-save mr-2"></i>Capture & Save
                        </button>
                    </div>
                </div>

                <form id="locationForm" class="space-y-3">
                    <input type="hidden" name="mode" value="create">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-teal-200 text-xs mb-1">ID</label>
                            <input name="id" required class="mc-input w-full text-sm" placeholder="village3">
                        </div>
                        <div>
                            <label class="block text-teal-200 text-xs mb-1">Name</label>
                            <input name="name" required class="mc-input w-full text-sm" placeholder="Village">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-teal-200 text-xs mb-1">X</label>
                            <input name="x" type="number" required class="mc-input w-full text-sm">
                        </div>
                        <div>
                            <label class="block text-teal-200 text-xs mb-1">Y</label>
                            <input name="y" type="number" required class="mc-input w-full text-sm">
                        </div>
                        <div>
                            <label class="block text-teal-200 text-xs mb-1">Z</label>
                            <input name="z" type="number" required class="mc-input w-full text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-teal-200 text-xs mb-1">Icon</label>
                            <input name="icon" class="mc-input w-full text-sm" placeholder="home">
                        </div>
                        <div>
                            <label class="block text-teal-200 text-xs mb-1">Description</label>
                            <input name="description" class="mc-input w-full text-sm" placeholder="Optional">
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" class="mc-button bg-gradient-to-b from-teal-600 to-teal-700 hover:from-teal-500 hover:to-teal-600 text-white px-4 py-2 font-semibold text-sm">
                            <i class="fas fa-save mr-2"></i>Save
                        </button>
                        <button type="button" id="cancelEdit" class="hidden mc-button bg-gradient-to-b from-gray-600 to-gray-700 hover:from-gray-500 hover:to-gray-600 text-white px-3 py-2 text-sm">
                            Cancel
                        </button>
                    </div>
                </form>

                <div class="mt-4 space-y-2" id="manageLocationsList"></div>
            </div>

            <!-- Custom Command Section -->
            <div class="mc-card p-6 grid-pattern">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
                    <div class="block-icon">
                        <i class="fas fa-terminal text-red-400"></i>
                    </div>
                    Custom Command
                </h2>
                
                <form id="commandForm" class="space-y-4">
                    <div>
                        <label class="block text-red-300 font-semibold mb-2 text-sm">
                            <i class="fas fa-user mr-2"></i>Player (optional)
                        </label>
                        <select name="player" class="mc-select w-full">
                            <option value="">No specific player</option>
                            {% for player in players %}
                            <option value="{{ player }}">{{ player }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-red-300 font-semibold mb-2 text-sm">
                            <i class="fas fa-code mr-2"></i>Command
                        </label>
                        <input type="text" name="command" placeholder="/gamemode creative @p" 
                               class="mc-input w-full font-mono text-sm">
                    </div>

                    <button type="submit" class="mc-button w-full bg-gradient-to-b from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white px-6 py-3 font-semibold">
                        <i class="fas fa-play mr-2"></i>Execute Command
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    /* Additional dashboard-specific styles */
    .mc-select {
        background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
        border: 3px solid #3a3a3a;
        color: white;
        padding: 0.75rem 1rem;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    }

    .mc-select:focus {
        outline: none;
        border-color: var(--mc-emerald);
        box-shadow: 
            inset 0 2px 4px rgba(0,0,0,0.3),
            0 0 0 3px rgba(23, 221, 98, 0.3);
    }

    .mc-input {
        background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
        border: 3px solid #3a3a3a;
        color: white;
        padding: 0.75rem 1rem;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.2s ease;
    }

    .mc-input:focus {
        outline: none;
        border-color: var(--mc-emerald);
        box-shadow: 
            inset 0 2px 4px rgba(0,0,0,0.3),
            0 0 0 3px rgba(23, 221, 98, 0.3);
    }

    .mc-input::placeholder {
        color: #666;
    }

    /* Item slot styling */
    .item-slot {
        background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
        border: 2px solid #3a3a3a;
        transition: all 0.2s ease;
    }

    .item-slot:hover {
        border-color: var(--mc-diamond);
        transform: scale(1.15) translateY(-4px);
        box-shadow: 0 0 20px rgba(93, 236, 245, 0.4);
        z-index: 10;
    }

    /* Section colored borders */
    .section-grass { border-top: 4px solid var(--mc-grass); }
    .section-diamond { border-top: 4px solid var(--mc-diamond); }
    .section-gold { border-top: 4px solid var(--mc-gold); }
    .section-redstone { border-top: 4px solid var(--mc-redstone); }
    .section-emerald { border-top: 4px solid var(--mc-emerald); }

    .block-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(145deg, #4a4a4a, #2a2a2a);
        border: 3px solid #3a3a3a;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 
            inset 0 2px 0 rgba(255,255,255,0.2),
            0 4px 0 rgba(0,0,0,0.3);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Give Item Function
    async function giveItem(itemName) {
        const form = document.getElementById('giveItemForm');
        const player = form.player.value;
        const amount = form.amount.value;
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('item', itemName);
        formData.append('amount', amount);
        
        try {
            const response = await fetch('/give', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification(`âœ“ Gave ${amount}x ${itemName} to ${player}`, 'success');
            } else {
                showNotification(data.error || 'Failed to give item', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Give Kit Function
    async function giveKit(kitName) {
        const form = document.getElementById('kitForm');
        const player = form.player.value;
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        
        try {
            const response = await fetch(`/kit/${kitName}`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification(`âœ“ Gave ${kitName} kit to ${player}`, 'success');
            } else {
                showNotification(data.error || 'Failed to give kit', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Quick Command Function
    async function quickCommand(commandType) {
        const playerSelect = document.getElementById('quickCommandPlayer');
        const player = playerSelect ? playerSelect.value : document.querySelector('#quickCommandForm select[name="player"]')?.value;
        
        const noPlayerCommands = [
            'day', 'night', 'clear_weather', 'rain', 'thunder',
            'difficulty_peaceful', 'difficulty_normal', 'difficulty_hard',
            'keep_inventory_on', 'keep_inventory_off',
            'mob_griefing_off', 'mob_griefing_on',
            'daylight_cycle_off', 'daylight_cycle_on',
            'worldborder_small', 'worldborder_medium', 'worldborder_large', 'worldborder_infinite',
            'clear_ground_items', 'spawn_villager_librarian', 'spawn_iron_golem'
        ];
        
        if (!player && !noPlayerCommands.includes(commandType)) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('command_type', commandType);
        
        try {
            const response = await fetch('/quick-command', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                const message = data.message || data.result || `âœ“ ${commandType.replace(/_/g, ' ')}`;
                showNotification(message, 'success');
            } else {
                showNotification(data.error || 'Failed to execute command', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Teleport Function
    async function teleportTo(locationId) {
        const form = document.getElementById('teleportForm');
        const player = form.player.value;
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('location_id', locationId);
        
        try {
            const response = await fetch('/tp', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification(`âœ“ Teleported ${player} to ${locationId}`, 'success');
            } else {
                showNotification(data.error || 'Failed to teleport', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Teleport to coordinates
    async function teleportToCoords() {
        const form = document.getElementById('teleportForm');
        const player = form.player.value;
        const x = form.querySelector('input[name="x"]').value;
        const y = form.querySelector('input[name="y"]').value;
        const z = form.querySelector('input[name="z"]').value;

        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        if (x === '' || y === '' || z === '') {
            showNotification('Enter X, Y, and Z coordinates', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('player', player);
        formData.append('x', x);
        formData.append('y', y);
        formData.append('z', z);

        try {
            const response = await fetch('/tp/coordinates', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification(`âœ“ Teleported ${player} to ${x}, ${y}, ${z}`, 'success');
            } else {
                showNotification(data.error || 'Failed to teleport', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Locate Village
    async function locateVillage(villageType) {
        const form = document.getElementById('locateForm');
        const player = form.player.value;
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('village_type', villageType);
        
        try {
            const response = await fetch('/locate', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification(`âœ“ Finding ${villageType} village`, 'info');
                document.getElementById('locationResult').classList.remove('hidden');
                document.getElementById('locationText').textContent = data.result;
            } else {
                showNotification(data.error || 'Failed to locate village', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Locations Management
    let editingLocationId = null;

    async function loadLocations() {
        const list = document.getElementById('locationsList');
        const manageList = document.getElementById('manageLocationsList');
        list.innerHTML = '<div class="text-gray-400 text-sm">Loading...</div>';
        manageList.innerHTML = '';
        
        try {
            const res = await fetch('/api/locations');
            const data = await res.json();
            const locations = data.locations || [];

            if (!locations.length) {
                list.innerHTML = '<div class="text-gray-400 text-sm">No locations saved.</div>';
                manageList.innerHTML = '<div class="text-gray-400 text-sm">No locations yet.</div>';
                return;
            }

            list.innerHTML = locations.map(loc => `
                <button type="button" onclick="teleportTo('${loc.id}')"
                        class="mc-button w-full bg-gradient-to-b from-gray-700 to-gray-800 hover:from-cyan-600 hover:to-cyan-700 text-white px-4 py-3 text-left text-sm"
                        title="${loc.description || ''}">
                    <i class="fas fa-${loc.icon || 'map-marker-alt'} mr-2"></i>
                    ${loc.name} <span class="text-gray-400 text-xs">(${loc.coordinates.x}, ${loc.coordinates.y}, ${loc.coordinates.z})</span>
                </button>
            `).join('');

            manageList.innerHTML = locations.map(loc => `
                <div class="mc-card p-3 flex items-center justify-between">
                    <div class="text-sm text-white">
                        <div class="font-semibold">${loc.name} <span class="text-gray-400">(${loc.id})</span></div>
                        <div class="text-gray-300 text-xs">${loc.coordinates.x}, ${loc.coordinates.y}, ${loc.coordinates.z}</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="mc-button bg-gradient-to-b from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white px-3 py-1 text-xs" data-action="edit" data-id="${loc.id}">Edit</button>
                        <button class="mc-button bg-gradient-to-b from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white px-3 py-1 text-xs" data-action="delete" data-id="${loc.id}">Delete</button>
                    </div>
                </div>
            `).join('');

            attachManageHandlers(locations);
        } catch (err) {
            list.innerHTML = '<div class="text-red-400 text-sm">Failed to load</div>';
        }
    }

    function attachManageHandlers(locations) {
        const manageList = document.getElementById('manageLocationsList');
        manageList.querySelectorAll('[data-action="edit"]').forEach(btn => {
            const id = btn.dataset.id;
            const loc = locations.find(l => l.id === id);
            btn.onclick = () => startEditLocation(loc);
        });
        manageList.querySelectorAll('[data-action="delete"]').forEach(btn => {
            const id = btn.dataset.id;
            btn.onclick = () => deleteLocation(id);
        });
    }

    function startEditLocation(loc) {
        editingLocationId = loc.id;
        const form = document.getElementById('locationForm');
        form.mode.value = 'edit';
        form.id.value = loc.id;
        form.id.disabled = true;
        form.name.value = loc.name;
        form.icon.value = loc.icon || '';
        form.description.value = loc.description || '';
        form.x.value = loc.coordinates.x;
        form.y.value = loc.coordinates.y;
        form.z.value = loc.coordinates.z;
        document.getElementById('cancelEdit').classList.remove('hidden');
    }

    async function deleteLocation(id) {
        if (!confirm('Delete location ' + id + '?')) return;
        await fetch(`/api/locations/${id}`, { method: 'DELETE' });
        if (editingLocationId === id) resetLocationForm();
        loadLocations();
        showNotification('Location deleted', 'success');
    }

    function resetLocationForm() {
        const form = document.getElementById('locationForm');
        form.reset();
        form.mode.value = 'create';
        form.id.disabled = false;
        editingLocationId = null;
        document.getElementById('cancelEdit').classList.add('hidden');
    }

    document.getElementById('cancelEdit').addEventListener('click', resetLocationForm);

    document.getElementById('locationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const payload = {
            id: formData.get('id'),
            name: formData.get('name'),
            icon: formData.get('icon'),
            description: formData.get('description'),
            x: formData.get('x'),
            y: formData.get('y'),
            z: formData.get('z'),
        };

        const method = form.mode.value === 'edit' ? 'PUT' : 'POST';
        const url = form.mode.value === 'edit' ? `/api/locations/${editingLocationId}` : '/api/locations';

        try {
            const res = await fetch(url, { method, body: toFormData(payload) });
            const data = await res.json();
            if (data.success) {
                showNotification('âœ“ Location saved', 'success');
                resetLocationForm();
                loadLocations();
            } else {
                showNotification(data.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showNotification('Failed to save location', 'error');
        }
    });

    function toFormData(obj) {
        const fd = new FormData();
        Object.entries(obj).forEach(([k, v]) => fd.append(k, v));
        return fd;
    }

    function setGamemode(mode) {
        const player = document.getElementById('topPlayerSelect').value;
        if (!player) {
            showNotification('Select a player first', 'error');
            return;
        }
        quickCommand(mode);
    }

    // Item filter
    const itemFilterInput = document.getElementById('itemFilter');
    if (itemFilterInput) {
        itemFilterInput.addEventListener('input', () => {
            const query = itemFilterInput.value.toLowerCase();
            document.querySelectorAll('.category-block').forEach(block => {
                let visibleCount = 0;
                block.querySelectorAll('.item-btn').forEach(btn => {
                    const text = `${btn.dataset.name} ${btn.dataset.display} ${btn.dataset.category}`.toLowerCase();
                    const show = text.includes(query);
                    btn.classList.toggle('hidden', !show);
                    if (show) visibleCount += 1;
                });
                block.classList.toggle('hidden', visibleCount === 0 && query.length > 0);
            });
        });
    }

    function slugifyName(name) {
        return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') || `loc-${Date.now()}`;
    }

    async function captureAndSaveLocation() {
        const player = document.getElementById('capturePlayer').value;
        const name = document.getElementById('captureName').value.trim();

        if (!player) {
            showNotification('Select a player to capture position', 'error');
            return;
        }
        if (!name) {
            showNotification('Enter a name for the location', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('player', player);

        try {
            const posRes = await fetch('/api/player-location', { method: 'POST', body: formData });
            const posData = await posRes.json();
            if (!posData.success) {
                showNotification(posData.error || 'Failed to fetch position', 'error');
                return;
            }

            const coords = posData.coordinates;
            const payload = {
                id: slugifyName(name),
                name,
                icon: 'map-marker-alt',
                description: '',
                x: coords.x,
                y: coords.y,
                z: coords.z,
            };

            const saveRes = await fetch('/api/locations', { method: 'POST', body: toFormData(payload) });
            const saveData = await saveRes.json();
            if (saveData.success) {
                showNotification('âœ“ Location saved', 'success');
                document.getElementById('captureName').value = '';
                loadLocations();
            } else {
                showNotification(saveData.error || 'Failed to save location', 'error');
            }
        } catch (err) {
            showNotification('Error: ' + err.message, 'error');
        }
    }

    async function removeUsage(itemName, event) {
        event.stopPropagation();
        if (!confirm('Remove this item from Most Used?')) return;
        
        try {
            const res = await fetch(`/api/usage/${itemName}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) {
                showNotification('âœ“ Item removed from Most Used', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                showNotification('Failed to remove item', 'error');
            }
        } catch (err) {
            showNotification('Error removing item', 'error');
        }
    }

    // Initial loads
    loadLocations();

    // Custom Command Form
    document.getElementById('commandForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        try {
            const response = await fetch('/command', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification('âœ“ Command executed successfully', 'success');
                e.target.command.value = '';
            } else {
                showNotification(data.error || 'Failed to execute command', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    });

    // Smooth scroll to anchors
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
</script>
{% endblock %}