 {% extends "base.html" %}

{% block content %}
<div id="pageShell" class="space-y-6">

    <!-- Header -->
    <div class="mc-card section-stone p-6 grid-pattern">
        <h1 class="text-2xl font-bold text-white flex items-center gap-3">
            <div class="block-icon">
                <i class="fas fa-cog text-blue-400"></i>
            </div>
            Server Settings
        </h1>
        <p class="text-gray-400 text-sm mt-2">Manage RCON connection settings and test server connectivity.</p>
    </div>

    <div class="grid lg:grid-cols-2 gap-6">
        <!-- Left Column: Diag Tools -->
        <div class="space-y-6">
            <!-- Connection Test -->
            <div class="mc-card p-6 grid-pattern">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-network-wired text-emerald-400"></i>
                         Connection Test
                    </h2>
                    <button onclick="testConnection()" class="mc-button bg-gradient-to-b from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white px-6 py-2 text-sm font-semibold">
                        <i class="fas fa-sync-alt mr-2"></i> Run Test
                    </button>
                </div>

                <div id="results" class="space-y-4 min-h-[100px]">
                    <div class="text-gray-500 text-center py-8">Click "Run Test" to check connection</div>
                </div>
            </div>

            <!-- Recent Errors (Small Widget) -->
            <div class="mc-card p-6 grid-pattern border-red-500/30">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                        Recent Errors
                    </h2>
                    <button onclick="loadErrorLogs()" class="text-xs text-blue-300 hover:text-white underline">Refresh</button>
                </div>
                <div id="errorLogs" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                    <p class="text-gray-400 text-sm">Loading...</p>
                </div>
                <div class="mt-4 text-center">
                    <a href="{{ url_for('main.error_logs_page') }}" class="text-sm text-blue-400 hover:text-blue-300">View Full Log History &rarr;</a>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-6">
            <!-- RCON Config Card -->
            <div class="mc-card p-6 section-stone grid-pattern">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-white flex items-center gap-3">
                        <div class="block-icon">
                            <i class="fas fa-sliders-h text-emerald-400"></i>
                        </div>
                        RCON Connection Settings
                    </h2>
                    <span class="text-xs text-gray-400">Source: {{ rcon_config.source|capitalize }}</span>
                </div>

                <div class="bg-black/20 p-4 rounded-lg border border-white/5 text-sm space-y-2">
                    <div class="flex justify-between"><span class="text-gray-400">Host</span><span class="text-white font-mono">{{ rcon_config.host }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Port</span><span class="text-white font-mono">{{ rcon_config.port }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Password set</span><span class="text-white font-mono">{{ 'Yes' if rcon_config.password else 'No' }}</span></div>
                </div>

                {% if current_user.role == 'admin' %}
                    {% if rcon_config.source == 'env' %}
                        <div class="mt-4 bg-amber-900/30 border border-amber-600/40 p-4 rounded text-amber-200 text-sm">
                            RCON values are currently managed via your .env file. Update the container environment to change them.
                        </div>
                    {% else %}
                        <form action="{{ url_for('main.update_rcon_config') }}" method="POST" class="mt-4 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm text-gray-300">Host
                                    <input type="text" name="host" value="{{ rcon_config.host }}" class="w-full bg-black/30 border border-white/10 rounded p-2 text-white text-sm mt-1" required>
                                </label>
                                <label class="text-sm text-gray-300">Port
                                    <input type="number" name="port" value="{{ rcon_config.port }}" class="w-full bg-black/30 border border-white/10 rounded p-2 text-white text-sm mt-1" required>
                                </label>
                            </div>
                            <label class="text-sm text-gray-300 block">Password
                                <input type="password" name="password" value="{{ rcon_config.password }}" class="w-full bg-black/30 border border-white/10 rounded p-2 text-white text-sm mt-1" required>
                            </label>
                            <p class="text-xs text-gray-400">Values are stored securely in the app database when .env does not provide them.</p>
                            <button type="submit" class="mc-button bg-gradient-to-b from-emerald-600 to-emerald-700 hover:from-emerald-500 hover:to-emerald-600 text-white px-4 py-2 text-sm font-semibold">Save RCON Settings</button>
                        </form>
                    {% endif %}
                {% else %}
                    <div class="mt-4 bg-gray-800/60 border border-white/10 p-4 rounded text-gray-300 text-sm">
                        Only admins can update RCON connection settings.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    async function testConnection() {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="text-white flex items-center justify-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i> Testing connection...</div>';

        try {
            const response = await fetch("{{ url_for('api.test_connection') }}");
            const data = await response.json();

            let html = '<div class="space-y-3 animation-fade-in">';

            // Connection Status
            html += `<div class="p-4 rounded-lg border-l-4 ${data.connected ? 'bg-emerald-900/30 border-emerald-500' : 'bg-red-900/30 border-red-500'}">
                <h3 class="font-bold ${data.connected ? 'text-emerald-400' : 'text-red-400'} flex items-center gap-2">
                    <i class="fas fa-${data.connected ? 'check-circle' : 'times-circle'}"></i>
                    ${data.connected ? 'Connection Successful' : 'Connection Failed'}
                </h3>
            </div>`;

            // Configuration Details
            html += `<div class="bg-black/30 p-4 rounded-lg border border-white/5">
                <div class="grid grid-cols-2 gap-2 text-sm font-mono">
                    <div class="text-gray-500">Host:</div>
                    <div class="text-white text-right">${data.host}</div>
                    <div class="text-gray-500">Port:</div>
                    <div class="text-white text-right">${data.port}</div>
                    <div class="text-gray-500">Source:</div>
                    <div class="text-white text-right capitalize">${data.source || 'default'}</div>
                    <div class="text-gray-500">Password Set:</div>
                    <div class="text-right ${data.password_set ? 'text-emerald-400' : 'text-red-400'}">
                        ${data.password_set ? '✓ Yes' : '✗ No'}
                    </div>
                </div>
            </div>`;

            // Server Response
            html += `<div class="bg-black/30 p-4 rounded-lg border border-white/5">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Server Response</h3>
                <pre class="text-xs ${data.connected ? 'text-emerald-300' : 'text-red-300'} font-mono whitespace-pre-wrap break-all">${data.response}</pre>
            </div>`;

            // Recommendations
            if (!data.connected) {
                html += '<div class="bg-amber-900/20 border border-amber-500/50 p-4 rounded-lg">';
                html += '<h3 class="font-bold text-amber-500 mb-2 text-sm"><i class="fas fa-wrench mr-2"></i>Suggested Fixes:</h3>';
                html += '<ul class="list-disc list-inside space-y-1 text-amber-200/80 text-xs">';
                
                if (!data.password_set) {
                    html += '<li>Set <strong>RCON_PASSWORD</strong> in your .env file</li>';
                }
                
                if (data.response.includes('Connection refused')) {
                    html += '<li>Start your Minecraft server</li><li>Ensure enable-rcon=true in server.properties</li>';
                } else if (data.response.includes('Authentication failed')) {
                    html += '<li>Verify RCON_PASSWORD in .env matches server.properties</li>';
                } else if (data.response.includes('timed out')) {
                    html += '<li>Check firewall settings for port 25575</li><li>Verify server IP/Host</li>';
                }
                
                html += '</ul></div>';
            }

            html += '</div>';
            resultsDiv.innerHTML = html;

        } catch (error) {
            resultsDiv.innerHTML = `<div class="bg-red-900/30 border border-red-500 p-4 rounded-lg text-red-300">
                <i class="fas fa-bomb mr-2"></i>
                Error testing connection: ${error.message}
            </div>`;
        }
    }

    async function loadErrorLogs(limit = 10) {
        const logsDiv = document.getElementById('errorLogs');
        logsDiv.innerHTML = '<p class="text-gray-400 text-sm text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</p>';
        
        try {
            const response = await fetch(`{{ url_for('api.api_error_logs') }}?limit=${limit}`);
            const data = await response.json();
            
            if (data.success && data.logs && data.logs.length > 0) {
                let html = '<div class="space-y-2">';
                data.logs.forEach(log => {
                    const timestamp = new Date(log.timestamp).toLocaleTimeString();
                    html += `
                        <div class="bg-black/20 border-l-2 border-red-500 p-2 rounded hover:bg-white/5 transition">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-red-400 font-bold text-xs uppercase">${log.command_type}</span>
                                <span class="text-gray-600 text-[10px] font-mono">${timestamp}</span>
                            </div>
                            <div class="text-gray-300 text-xs font-mono break-all line-clamp-2" title="${log.error_message}">
                                ${log.error_message}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                logsDiv.innerHTML = html;
            } else {
                logsDiv.innerHTML = '<div class="text-center py-4"><p class="text-emerald-400 text-sm"><i class="fas fa-check-circle mb-1 block text-xl"></i>No errors found</p></div>';
            }
        } catch (error) {
            logsDiv.innerHTML = `<p class="text-red-400 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to load logs</p>`;
        }
    }

    // Auto-test on page load
    window.addEventListener('load', () => {
        // Optional: Auto run test? Maybe just load logs. Dashboard usually loads data.
        // Let's not auto-run heavy connection test, but we will load logs.
        // testConnection(); 
        loadErrorLogs();
    });
</script>
{% endblock %}
