{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- Left Column: Give Items & Kits -->
    <div class="lg:col-span-2 space-y-6">
        
        <!-- Give Items Section -->
        <div class="bg-black bg-opacity-40 backdrop-blur-md rounded-xl shadow-2xl p-6 border border-green-500">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-gift text-yellow-400 mr-3"></i>
                Give Items
            </h2>
            
            <form id="giveItemForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-green-300 font-semibold mb-2">
                            <i class="fas fa-user"></i> Player
                        </label>
                        <select name="player" required class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-green-500 focus:border-green-400 focus:ring-2 focus:ring-green-400 focus:outline-none">
                            {% if players|length == 0 %}
                            <option value="">No players online</option>
                            {% elif players|length == 1 %}
                            <option value="{{ players[0] }}" selected>{{ players[0] }} (Auto-selected)</option>
                            {% else %}
                            <option value="">Select Player</option>
                            {% for player in players %}
                            <option value="{{ player }}">{{ player }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-green-300 font-semibold mb-2">
                            <i class="fas fa-hashtag"></i> Amount
                        </label>
                        <input type="number" name="amount" value="1" min="1" max="64" class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-green-500 focus:border-green-400 focus:ring-2 focus:ring-green-400 focus:outline-none">
                    </div>
                </div>

                <!-- Item Categories -->
                <div class="space-y-3">
                    {% for category, items_list in items.items() %}
                    <div>
                        <h3 class="text-lg font-semibold text-green-300 mb-2">{{ category }}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2">
                            {% for item in items_list %}
                            <button type="button" onclick="giveItem('{{ item.name }}')" 
                                    class="bg-gray-800 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition transform hover:scale-105 border border-gray-700 hover:border-green-400">
                                <span class="text-xl">{{ item.icon }}</span>
                                <div class="text-xs mt-1">{{ item.display }}</div>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </form>
        </div>

        <!-- Quick Kits Section -->
        <div class="bg-black bg-opacity-40 backdrop-blur-md rounded-xl shadow-2xl p-6 border border-purple-500">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-box-open text-purple-400 mr-3"></i>
                Quick Kits
            </h2>
            
            <form id="kitForm">
                <div class="mb-4">
                    <label class="block text-purple-300 font-semibold mb-2">
                        <i class="fas fa-user"></i> Player
                    </label>
                    <select name="player" required class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-purple-500 focus:border-purple-400 focus:ring-2 focus:ring-purple-400 focus:outline-none">
                        {% if players|length == 0 %}
                        <option value="">No players online</option>
                        {% elif players|length == 1 %}
                        <option value="{{ players[0] }}" selected>{{ players[0] }} (Auto-selected)</option>
                        {% else %}
                        <option value="">Select Player</option>
                        {% for player in players %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    {% for kit in kits %}
                    <button type="button" onclick="giveKit('{{ kit.id }}')" 
                            class="bg-gradient-to-br from-{{ kit.color }}-600 to-{{ kit.color }}-700 hover:from-{{ kit.color }}-500 hover:to-{{ kit.color }}-600 text-white px-4 py-3 rounded-lg font-semibold transition transform hover:scale-105 shadow-lg"
                            title="{{ kit.description }}">
                        <i class="fas fa-{{ kit.icon }} text-xl mb-1"></i>
                        <div class="text-sm">{{ kit.name }}</div>
                    </button>
                    {% endfor %}
                </div>
            </form>
        </div>

        <!-- Quick Commands Section -->
        <div class="bg-black bg-opacity-40 backdrop-blur-md rounded-xl shadow-2xl p-6 border border-indigo-500">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-bolt text-indigo-400 mr-3"></i>
                Quick Commands
            </h2>
            
            <form id="quickCommandForm">
                <div class="mb-4">
                    <label class="block text-indigo-300 font-semibold mb-2">
                        <i class="fas fa-user"></i> Player
                    </label>
                    <select name="player" required class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-indigo-500 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                        {% if players|length == 0 %}
                        <option value="">No players online</option>
                        {% elif players|length == 1 %}
                        <option value="{{ players[0] }}" selected>{{ players[0] }} (Auto-selected)</option>
                        {% else %}
                        <option value="">Select Player</option>
                        {% for player in players %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="space-y-3">
                    <div>
                        <h3 class="text-sm font-semibold text-indigo-300 mb-2">Gamemode</h3>
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button" onclick="quickCommand('gamemode_survival')" class="bg-gray-800 hover:bg-green-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-heart mr-1"></i> Survival
                            </button>
                            <button type="button" onclick="quickCommand('gamemode_creative')" class="bg-gray-800 hover:bg-blue-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-wand-magic-sparkles mr-1"></i> Creative
                            </button>
                            <button type="button" onclick="quickCommand('gamemode_adventure')" class="bg-gray-800 hover:bg-purple-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-map mr-1"></i> Adventure
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-indigo-300 mb-2">Player Actions</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" onclick="quickCommand('heal')" class="bg-gray-800 hover:bg-red-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-heart mr-1"></i> Heal
                            </button>
                            <button type="button" onclick="quickCommand('feed')" class="bg-gray-800 hover:bg-orange-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-drumstick-bite mr-1"></i> Feed
                            </button>
                            <button type="button" onclick="quickCommand('give_xp')" class="bg-gray-800 hover:bg-green-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-star mr-1"></i> +1000 XP
                            </button>
                            <button type="button" onclick="quickCommand('clear_inventory')" class="bg-gray-800 hover:bg-red-700 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-trash mr-1"></i> Clear Inv
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-indigo-300 mb-2">Effects</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" onclick="quickCommand('speed')" class="bg-gray-800 hover:bg-cyan-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-wind mr-1"></i> Speed
                            </button>
                            <button type="button" onclick="quickCommand('jump_boost')" class="bg-gray-800 hover:bg-teal-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-up-long mr-1"></i> Jump
                            </button>
                            <button type="button" onclick="quickCommand('night_vision')" class="bg-gray-800 hover:bg-yellow-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-eye mr-1"></i> Night Vision
                            </button>
                            <button type="button" onclick="quickCommand('fire_resistance')" class="bg-gray-800 hover:bg-orange-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-fire mr-1"></i> Fire Resist
                            </button>
                            <button type="button" onclick="quickCommand('water_breathing')" class="bg-gray-800 hover:bg-blue-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-water mr-1"></i> Water Breath
                            </button>
                            <button type="button" onclick="quickCommand('clear_effects')" class="bg-gray-800 hover:bg-gray-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-times mr-1"></i> Clear Effects
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-indigo-300 mb-2">World</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" onclick="quickCommand('day')" class="bg-gray-800 hover:bg-yellow-500 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-sun mr-1"></i> Day
                            </button>
                            <button type="button" onclick="quickCommand('night')" class="bg-gray-800 hover:bg-indigo-700 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-moon mr-1"></i> Night
                            </button>
                            <button type="button" onclick="quickCommand('clear_weather')" class="bg-gray-800 hover:bg-blue-400 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-cloud-sun mr-1"></i> Clear
                            </button>
                            <button type="button" onclick="quickCommand('rain')" class="bg-gray-800 hover:bg-blue-600 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-cloud-rain mr-1"></i> Rain
                            </button>
                            <button type="button" onclick="quickCommand('thunder')" class="bg-gray-800 hover:bg-purple-700 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-bolt mr-1"></i> Thunder
                            </button>
                            <button type="button" onclick="quickCommand('clear_ground_items')" class="bg-gray-800 hover:bg-red-700 text-white px-3 py-2 rounded text-xs transition">
                                <i class="fas fa-broom mr-1"></i> Clear Drops
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-indigo-300 mb-2">Difficulty</h3>
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button" onclick="quickCommand('difficulty_peaceful')" class="bg-gray-800 hover:bg-green-600 text-white px-3 py-2 rounded text-xs transition">
                                Peaceful
                            </button>
                            <button type="button" onclick="quickCommand('difficulty_normal')" class="bg-gray-800 hover:bg-yellow-600 text-white px-3 py-2 rounded text-xs transition">
                                Normal
                            </button>
                            <button type="button" onclick="quickCommand('difficulty_hard')" class="bg-gray-800 hover:bg-red-600 text-white px-3 py-2 rounded text-xs transition">
                                Hard
                            </button>
                        </div>
                    </div>

                    <!-- Rules block removed per request -->

                    <div>
                        <h3 class="text-sm font-semibold text-indigo-300 mb-2">World Border</h3>
                        <div class="grid grid-cols-4 gap-2">
                            <button type="button" onclick="quickCommand('worldborder_small')" class="bg-gray-800 hover:bg-red-600 text-white px-3 py-2 rounded text-xs transition">500</button>
                            <button type="button" onclick="quickCommand('worldborder_medium')" class="bg-gray-800 hover:bg-yellow-600 text-white px-3 py-2 rounded text-xs transition">2k</button>
                            <button type="button" onclick="quickCommand('worldborder_large')" class="bg-gray-800 hover:bg-green-600 text-white px-3 py-2 rounded text-xs transition">5k</button>
                            <button type="button" onclick="quickCommand('worldborder_infinite')" class="bg-gray-800 hover:bg-blue-600 text-white px-3 py-2 rounded text-xs transition">Infinite</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-indigo-300 mb-2">Admin & Utility</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" onclick="quickCommand('op_player')" class="bg-gray-800 hover:bg-red-600 text-white px-3 py-2 rounded text-xs transition">OP</button>
                            <button type="button" onclick="quickCommand('deop_player')" class="bg-gray-800 hover:bg-gray-600 text-white px-3 py-2 rounded text-xs transition">De-OP</button>
                            <button type="button" onclick="quickCommand('whitelist_add')" class="bg-gray-800 hover:bg-green-600 text-white px-3 py-2 rounded text-xs transition">Whitelist +</button>
                            <button type="button" onclick="quickCommand('whitelist_remove')" class="bg-gray-800 hover:bg-red-600 text-white px-3 py-2 rounded text-xs transition">Whitelist -</button>
                            <button type="button" onclick="quickCommand('xp_reset')" class="bg-gray-800 hover:bg-blue-600 text-white px-3 py-2 rounded text-xs transition">Reset XP</button>
                            <button type="button" onclick="quickCommand('hero_of_village')" class="bg-gray-800 hover:bg-purple-600 text-white px-3 py-2 rounded text-xs transition">Hero Buff</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-indigo-300 mb-2">Village Helpers</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" onclick="quickCommand('spawn_villager_librarian')" class="bg-gray-800 hover:bg-indigo-600 text-white px-3 py-2 rounded text-xs transition">Summon Librarian</button>
                            <button type="button" onclick="quickCommand('spawn_iron_golem')" class="bg-gray-800 hover:bg-green-600 text-white px-3 py-2 rounded text-xs transition">Summon Golem</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Right Column: Teleport & Villages -->
    <div class="space-y-6">
        
        <!-- Teleport Section -->
        <div class="bg-black bg-opacity-40 backdrop-blur-md rounded-xl shadow-2xl p-6 border border-blue-500">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-location-arrow text-blue-400 mr-3"></i>
                Teleport
            </h2>
            
            <form id="teleportForm" class="space-y-4">
                <div>
                    <label class="block text-blue-300 font-semibold mb-2">
                        <i class="fas fa-user"></i> Player
                    </label>
                    <select name="player" required class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-blue-500 focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:outline-none">
                        {% if players|length == 0 %}
                        <option value="">No players online</option>
                        {% elif players|length == 1 %}
                        <option value="{{ players[0] }}" selected>{{ players[0] }} (Auto-selected)</option>
                        {% else %}
                        <option value="">Select Player</option>
                        {% for player in players %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div>
                    <label class="block text-blue-300 font-semibold mb-2">
                        <i class="fas fa-map-marker-alt"></i> Preset Locations
                    </label>
                    <div id="locationsList" class="space-y-2"></div>
                </div>
            </form>
        </div>

        <!-- Find Villages Section -->
        <div class="bg-black bg-opacity-40 backdrop-blur-md rounded-xl shadow-2xl p-6 border border-orange-500">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-compass text-orange-400 mr-3"></i>
                Find Villages
            </h2>
            
            <form id="locateForm" class="space-y-4">
                <div>
                    <label class="block text-orange-300 font-semibold mb-2">
                        <i class="fas fa-user"></i> Player
                    </label>
                    <select name="player" required class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-orange-500 focus:border-orange-400 focus:ring-2 focus:ring-orange-400 focus:outline-none">
                        {% if players|length == 0 %}
                        <option value="">No players online</option>
                        {% elif players|length == 1 %}
                        <option value="{{ players[0] }}" selected>{{ players[0] }} (Auto-selected)</option>
                        {% else %}
                        <option value="">Select Player</option>
                        {% for player in players %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div>
                    <label class="block text-orange-300 font-semibold mb-2">
                        <i class="fas fa-mountain"></i> Village Type
                    </label>
                    <div class="grid grid-cols-1 gap-2">
                        {% for vtype in village_types %}
                        <button type="button" onclick="locateVillage('{{ vtype }}')" class="bg-gray-800 hover:bg-orange-600 text-white px-4 py-3 rounded-lg transition text-left border border-gray-700 hover:border-orange-400">
                            <i class="fas fa-{{ 'tree' if vtype == 'taiga' else 'sun' if vtype == 'desert' else 'cloud-sun' if vtype == 'plains' else 'snowflake' if vtype == 'snowy' else 'leaf' }} mr-2"></i>
                            {{ vtype.title() }} Village
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </form>

            <div id="locationResult" class="mt-4 hidden">
                <div class="bg-green-900 bg-opacity-50 border border-green-500 rounded-lg p-4">
                    <p class="text-green-200 font-mono" id="locationText"></p>
                </div>
            </div>

        </div>

        <!-- Manage Locations Section -->
        <div class="bg-black bg-opacity-40 backdrop-blur-md rounded-xl shadow-2xl p-6 border border-teal-500">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-map-marked-alt text-teal-300 mr-3"></i>
                Manage Locations
            </h2>

            <form id="locationForm" class="space-y-3">
                <input type="hidden" name="mode" value="create">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">ID (slug)</label>
                        <input name="id" required class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="village3">
                    </div>
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">Name</label>
                        <input name="name" required class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="New Village">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">X</label>
                        <input name="x" type="number" required class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">Y</label>
                        <input name="y" type="number" required class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="64">
                    </div>
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">Z</label>
                        <input name="z" type="number" required class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="0">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">Icon (font-awesome, no fa-)</label>
                        <input name="icon" class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="home">
                    </div>
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">Description</label>
                        <input name="description" class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="Optional">
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <button type="submit" class="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 rounded font-semibold">Save</button>
                    <button type="button" id="cancelEdit" class="hidden bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded">Cancel edit</button>
                </div>
            </form>

            <div class="mt-4 space-y-2" id="manageLocationsList"></div>
        </div>

        <!-- Custom Command Section -->
        <div class="bg-black bg-opacity-40 backdrop-blur-md rounded-xl shadow-2xl p-6 border border-red-500">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-terminal text-red-400 mr-3"></i>
                Custom Command
            </h2>
            
            <form id="commandForm" class="space-y-4">
                <div>
                    <label class="block text-red-300 font-semibold mb-2">
                        <i class="fas fa-user"></i> Player (optional)
                    </label>
                    <select name="player" class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-red-500 focus:border-red-400 focus:ring-2 focus:ring-red-400 focus:outline-none">
                        <option value="">No specific player</option>
                        {% for player in players %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-red-300 font-semibold mb-2">
                        <i class="fas fa-code"></i> Command
                    </label>
                    <input type="text" name="command" placeholder="/gamemode creative @p" class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-red-500 focus:border-red-400 focus:ring-2 focus:ring-red-400 focus:outline-none font-mono">
                </div>

                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105 shadow-lg">
                    <i class="fas fa-play"></i> Execute Command
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Give Item Function
    async function giveItem(itemName) {
        console.log('=== GIVE ITEM FUNCTION ===');
        const form = document.getElementById('giveItemForm');
        const player = form.player.value;
        const amount = form.amount.value;
        console.log('Player:', player);
        console.log('Item:', itemName);
        console.log('Amount:', amount);
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('item', itemName);
        formData.append('amount', amount);
        
        try {
            console.log('Sending give item request...');
            const response = await fetch('/give', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            console.log('Response:', data);
            if (data.success) {
                showNotification(`Gave ${amount}x ${itemName} to ${player}`);
            } else {
                showNotification('Failed to give item', 'error');
            }
        } catch (error) {
            console.error('Give item error:', error);
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Give Kit Function
    async function giveKit(kitName) {
        console.log('=== GIVE KIT FUNCTION ===');
        const form = document.getElementById('kitForm');
        const player = form.player.value;
        console.log('Player:', player);
        console.log('Kit:', kitName);
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        
        try {
            console.log('Sending give kit request...');
            const response = await fetch(`/kit/${kitName}`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            console.log('Response:', data);
            if (data.success) {
                showNotification(`Gave ${kitName} kit to ${player}`);
            } else {
                showNotification('Failed to give kit', 'error');
            }
        } catch (error) {
            console.error('Give kit error:', error);
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Quick Command Function
    async function quickCommand(commandType) {
        console.log('=== QUICK COMMAND FUNCTION ===');
        const form = document.getElementById('quickCommandForm');
        const player = form.player.value;
        console.log('Player:', player);
        console.log('Command Type:', commandType);
        
        // Some commands don't require player selection
        const noPlayerCommands = [
            'day', 'night', 'clear_weather', 'rain', 'thunder',
            'difficulty_peaceful', 'difficulty_normal', 'difficulty_hard',
            'keep_inventory_on', 'keep_inventory_off',
            'mob_griefing_off', 'mob_griefing_on',
            'daylight_cycle_off', 'daylight_cycle_on',
            'worldborder_small', 'worldborder_medium', 'worldborder_large', 'worldborder_infinite',
            'clear_ground_items', 'spawn_villager_librarian', 'spawn_iron_golem'
        ];
        
        if (!player && !noPlayerCommands.includes(commandType)) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('command_type', commandType);
        
        try {
            console.log('Sending quick command request...');
            const response = await fetch('/quick-command', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            console.log('Response:', data);
            if (data.success) {
                showNotification(`Command executed: ${commandType.replace('_', ' ')}`);
            } else {
                showNotification('Failed to execute command', 'error');
            }
        } catch (error) {
            console.error('Quick command error:', error);
            showNotification('Error: ' + error.message, 'error');
        }
    }
    // Teleport Function
    async function teleportTo(locationId) {
        console.log('=== TELEPORT FUNCTION ===');
        const form = document.getElementById('teleportForm');
        const player = form.player.value;
        console.log('Player:', player);
        console.log('Location ID:', locationId);
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('location_id', locationId);
        
        try {
            console.log('Sending teleport request...');
            const response = await fetch('/tp', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            console.log('Response:', data);
            if (data.success) {
                showNotification(`Teleported ${player} to ${locationId}`);
            } else {
                showNotification('Failed to teleport', 'error');
            }
        } catch (error) {
            console.error('Teleport error:', error);
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Locate Village Function
    async function locateVillage(villageType) {
        const form = document.getElementById('locateForm');
        const player = form.player.value;
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('village_type', villageType);
        
        try {
            const response = await fetch('/locate', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification(`Finding ${villageType} village for ${player}`);
                document.getElementById('locationResult').classList.remove('hidden');
                document.getElementById('locationText').textContent = data.result;
            } else {
                showNotification('Failed to locate village', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // ---- Locations (DB-backed) ----
    let editingLocationId = null;

    async function loadLocations() {
        const list = document.getElementById('locationsList');
        const manageList = document.getElementById('manageLocationsList');
        list.innerHTML = '<div class="text-gray-400 text-sm">Loading...</div>';
        manageList.innerHTML = '';
        try {
            const res = await fetch('/api/locations');
            const data = await res.json();
            const locations = data.locations || [];

            if (!locations.length) {
                list.innerHTML = '<div class="text-gray-400 text-sm">No locations saved.</div>';
                manageList.innerHTML = '<div class="text-gray-400 text-sm">No locations yet.</div>';
                return;
            }

            list.innerHTML = locations.map(loc => `
                <button type="button" onclick="teleportTo('${loc.id}')"
                        class="w-full bg-gray-800 hover:bg-blue-600 text-white px-4 py-3 rounded-lg transition text-left border border-gray-700 hover:border-blue-400"
                        title="${loc.description || ''}">
                    <i class="fas fa-${loc.icon || 'map-marker-alt'} mr-2"></i>
                    ${loc.name} (${loc.coordinates.x}, ${loc.coordinates.y}, ${loc.coordinates.z})
                </button>
            `).join('');

            manageList.innerHTML = locations.map(loc => `
                <div class="flex items-center justify-between bg-gray-900 bg-opacity-60 border border-gray-700 rounded-lg px-3 py-2">
                    <div class="text-sm text-white">
                        <div class="font-semibold">${loc.name} <span class="text-gray-400">(${loc.id})</span></div>
                        <div class="text-gray-300">${loc.coordinates.x}, ${loc.coordinates.y}, ${loc.coordinates.z}</div>
                        <div class="text-gray-400 text-xs">${loc.description || ''}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs" data-action="edit" data-id="${loc.id}">Edit</button>
                        <button class="bg-red-700 hover:bg-red-600 text-white px-3 py-1 rounded text-xs" data-action="delete" data-id="${loc.id}">Delete</button>
                    </div>
                </div>
            `).join('');

            attachManageHandlers(locations);
        } catch (err) {
            list.innerHTML = '<div class="text-red-400 text-sm">Failed to load locations</div>';
            manageList.innerHTML = '<div class="text-red-400 text-sm">Failed to load locations</div>';
        }
    }

    function attachManageHandlers(locations) {
        const manageList = document.getElementById('manageLocationsList');
        manageList.querySelectorAll('[data-action="edit"]').forEach(btn => {
            const id = btn.dataset.id;
            const loc = locations.find(l => l.id === id);
            btn.onclick = () => startEditLocation(loc);
        });
        manageList.querySelectorAll('[data-action="delete"]').forEach(btn => {
            const id = btn.dataset.id;
            btn.onclick = () => deleteLocation(id);
        });
    }

    function startEditLocation(loc) {
        editingLocationId = loc.id;
        const form = document.getElementById('locationForm');
        form.mode.value = 'edit';
        form.id.value = loc.id;
        form.id.disabled = true;
        form.name.value = loc.name;
        form.icon.value = loc.icon || '';
        form.description.value = loc.description || '';
        form.x.value = loc.coordinates.x;
        form.y.value = loc.coordinates.y;
        form.z.value = loc.coordinates.z;
        document.getElementById('cancelEdit').classList.remove('hidden');
    }

    async function deleteLocation(id) {
        if (!confirm('Delete location ' + id + '?')) return;
        await fetch(`/api/locations/${id}`, { method: 'DELETE' });
        if (editingLocationId === id) resetLocationForm();
        loadLocations();
        showNotification('Location deleted');
    }

    function resetLocationForm() {
        const form = document.getElementById('locationForm');
        form.reset();
        form.mode.value = 'create';
        form.id.disabled = false;
        editingLocationId = null;
        document.getElementById('cancelEdit').classList.add('hidden');
    }

    document.getElementById('cancelEdit').addEventListener('click', resetLocationForm);

    document.getElementById('locationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const payload = {
            id: formData.get('id'),
            name: formData.get('name'),
            icon: formData.get('icon'),
            description: formData.get('description'),
            x: formData.get('x'),
            y: formData.get('y'),
            z: formData.get('z'),
        };

        const method = form.mode.value === 'edit' ? 'PUT' : 'POST';
        const url = form.mode.value === 'edit' ? `/api/locations/${editingLocationId}` : '/api/locations';

        try {
            const res = await fetch(url, { method, body: toFormData(payload) });
            const data = await res.json();
            if (data.success) {
                showNotification('Location saved');
                resetLocationForm();
                loadLocations();
            } else {
                showNotification(data.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showNotification('Failed to save location', 'error');
        }
    });

    function toFormData(obj) {
        const fd = new FormData();
        Object.entries(obj).forEach(([k, v]) => fd.append(k, v));
        return fd;
    }

    // Initial loads
    loadLocations();

    // Custom Command Form
    document.getElementById('commandForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        try {
            const response = await fetch('/command', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification('Command executed successfully');
                e.target.command.value = '';
            } else {
                showNotification('Failed to execute command', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    });
</script>
{% endblock %}
