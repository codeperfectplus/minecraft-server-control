{% extends "base.html" %}

{% block content %}
<div id="pageShell" class="transition-all duration-300 lg:pl-64 space-y-6">
<!-- Top Control Bar -->
<div class="mb-3 space-y-3">
    <!-- Section Navigation -->
    <div class="glass px-3 py-2 rounded-xl section-shell">
        <div class="flex flex-wrap gap-2">
            <a href="#items" class="px-2 py-1.5 rounded-lg bg-white/5 text-teal-100 hover:bg-white/10 transition text-xs flex items-center gap-1.5"><i class="fas fa-gift"></i><span class="hidden sm:inline">Items</span></a>
            <a href="#kits" class="px-2 py-1.5 rounded-lg bg-white/5 text-teal-100 hover:bg-white/10 transition text-xs flex items-center gap-1.5"><i class="fas fa-box-open"></i><span class="hidden sm:inline">Kits</span></a>
            <a href="#commands" class="px-2 py-1.5 rounded-lg bg-white/5 text-teal-100 hover:bg-white/10 transition text-xs flex items-center gap-1.5"><i class="fas fa-bolt"></i><span class="hidden sm:inline">Commands</span></a>
            <a href="#teleport" class="px-2 py-1.5 rounded-lg bg-white/5 text-teal-100 hover:bg-white/10 transition text-xs flex items-center gap-1.5"><i class="fas fa-location-arrow"></i><span class="hidden sm:inline">Teleport</span></a>
            <a href="#villages" class="px-2 py-1.5 rounded-lg bg-white/5 text-teal-100 hover:bg-white/10 transition text-xs flex items-center gap-1.5"><i class="fas fa-compass"></i><span class="hidden sm:inline">Villages</span></a>
            <a href="#locations" class="px-2 py-1.5 rounded-lg bg-white/5 text-teal-100 hover:bg-white/10 transition text-xs flex items-center gap-1.5"><i class="fas fa-map-marked-alt"></i><span class="hidden sm:inline">Locations</span></a>
        </div>
    </div>
    
    <!-- Stats & Controls -->
    <div class="glass px-3 py-2 rounded-xl section-shell">
        <div class="flex flex-wrap items-center justify-between gap-2">
            <!-- Stats Badges -->
            <div class="flex flex-wrap gap-2 text-xs">
                <span class="px-2 py-1.5 rounded-lg bg-white/5 border border-white/10 text-teal-100 flex items-center gap-1.5"><i class="fas fa-users"></i>{{ players|length }}</span>
                <span class="px-2 py-1.5 rounded-lg bg-white/5 border border-white/10 text-teal-100 flex items-center gap-1.5"><i class="fas fa-map-marker-alt"></i>{{ locations|length }}</span>
                <span class="px-2 py-1.5 rounded-lg bg-white/5 border border-white/10 text-teal-100 flex items-center gap-1.5"><i class="fas fa-box"></i>{{ kits|length }}</span>
            </div>

            <!-- Action Controls -->
            <div class="flex flex-wrap gap-2 items-center">
                <button type="button" onclick="toggleQuickAccess()" class="lg:hidden px-2 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-teal-100 text-xs font-semibold shadow">
                    <i class="fas fa-bars"></i>
                </button>
                <select id="topPlayerSelect" class="px-2 py-1.5 text-xs bg-gray-900 text-white rounded-lg border border-indigo-500 focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                    {% if players|length == 0 %}
                    <option value="">No players</option>
                    {% elif players|length == 1 %}
                    <option value="{{ players[0] }}" selected>{{ players[0] }}</option>
                    {% else %}
                    <option value="">Select player</option>
                    {% for player in players %}
                    <option value="{{ player }}">{{ player }}</option>
                    {% endfor %}
                    {% endif %}
                </select>
                <button type="button" onclick="setGamemode('gamemode_creative')" class="px-2 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-semibold shadow">
                    <i class="fas fa-wand-magic-sparkles"></i><span class="hidden md:inline ml-1">Creative</span>
                </button>
                <button type="button" onclick="setGamemode('gamemode_survival')" class="px-2 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-semibold shadow">
                    <i class="fas fa-shield-halved"></i><span class="hidden md:inline ml-1">Survival</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Commands Section - Redesigned -->
<div id="commands" class="glass rounded-xl shadow-2xl p-6 lg:p-8 border border-indigo-500/50 section-shell">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-white flex items-center">
            <i class="fas fa-bolt text-indigo-400 mr-3"></i>
            Quick Commands
        </h2>
        <select id="quickCommandPlayer" class="px-4 py-2 bg-gray-800 text-white rounded-lg border border-indigo-500 focus:ring-2 focus:ring-indigo-400 focus:outline-none">
            {% if players|length == 0 %}
            <option value="">No players online</option>
            {% elif players|length == 1 %}
            <option value="{{ players[0] }}" selected>{{ players[0] }}</option>
            {% else %}
            <option value="">Select Player</option>
            {% for player in players %}
            <option value="{{ player }}">{{ player }}</option>
            {% endfor %}
            {% endif %}
        </select>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
        {% for category in quick_commands %}
        <div class="glass rounded-lg p-5 border border-{{ category.border_color }}-500/30">
            <h3 class="text-lg font-semibold text-{{ category.text_color }}-300 mb-3 flex items-center">
                <i class="fas fa-{{ category.category_icon }} mr-2"></i> {{ category.name }}
            </h3>
            <div class="grid grid-cols-{{ category.grid_cols }} gap-2">
                {% for cmd in category.commands %}
                <button type="button" onclick="quickCommand('{{ cmd.id }}')" 
                        class="bg-gradient-to-br from-{{ cmd.color }}-600 to-{{ cmd.color }}-700 hover:from-{{ cmd.color }}-500 hover:to-{{ cmd.color }}-600 text-white px-4 py-3 rounded-lg text-sm font-medium transition shadow-lg hover:shadow-xl{% if category.grid_cols == 1 %} flex items-center justify-center{% endif %}"
                        title="{{ cmd.description|default('') }}">
                    <i class="fas fa-{{ cmd.icon }} mr-2"></i>{{ cmd.label }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Quick Access Sidebar -->
<div id="quickAccessNav" class="hidden lg:block fixed left-4 top-36 glass rounded-xl section-shell p-3 w-48 space-y-2 text-sm z-20" style="max-height: calc(100vh - 10rem); overflow-y: auto;">
    <div class="text-teal-100 font-semibold text-xs flex items-center gap-2 mb-2">
        <i class="fas fa-list"></i> Quick Access
        <button onclick="toggleQuickAccess()" class="ml-auto text-teal-300 hover:text-teal-100">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="space-y-1">
        {% for category, items_list in items.items() %}
        <a href="#cat-{{ category|replace(' ', '-')|lower }}" class="block px-2 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-teal-50 transition text-xs">
            {{ category }}
        </a>
        {% endfor %}
    </div>
</div>

<!-- Main Content Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- Left Column: Give Items & Kits -->
    <div class="lg:col-span-2 space-y-6">
        
        <!-- Give Items Section -->
        <div id="items" class="glass rounded-xl shadow-2xl p-6 border border-green-500/50 section-shell">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-gift text-yellow-400 mr-3"></i>
                Give Items
            </h2>
            
            <form id="giveItemForm" class="space-y-4">
                <div class="flex flex-col md:flex-row md:items-center md:space-x-3 space-y-3 md:space-y-0">
                    <div class="flex-1">
                        <label class="block text-green-300 font-semibold mb-2">
                            <i class="fas fa-magnifying-glass"></i> Search Items
                        </label>
                        <input id="itemFilter" type="text" placeholder="Search by name or type..." class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-green-500 focus:border-green-400 focus:ring-2 focus:ring-green-400 focus:outline-none" />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-green-300 font-semibold mb-2">
                            <i class="fas fa-user"></i> Player
                        </label>
                        <select name="player" required class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-green-500 focus:border-green-400 focus:ring-2 focus:ring-green-400 focus:outline-none">
                            {% if players|length == 0 %}

                            <option value="">No players online</option>
                            {% elif players|length == 1 %}
                            <option value="{{ players[0] }}" selected>{{ players[0] }} (Auto-selected)</option>
                            {% else %}
                            <option value="">Select Player</option>
                            {% for player in players %}
                            <option value="{{ player }}">{{ player }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-green-300 font-semibold mb-2">
                            <i class="fas fa-hashtag"></i> Amount
                        </label>
                        <input type="number" name="amount" value="1" min="1" max="64" class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-green-500 focus:border-green-400 focus:ring-2 focus:ring-green-400 focus:outline-none">
                    </div>
                </div>

                <!-- Item Categories -->
                <div class="space-y-3">
                    {% for category, items_list in items.items() %}
                    <div class="category-block" id="cat-{{ category|replace(' ', '-')|lower }}" data-category="{{ category|lower }}">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-green-300">{{ category }}</h3>
                            <span class="text-xs text-gray-400">{{ items_list|length }} items</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2">
                            {% for item in items_list %}
                            <button type="button" onclick="giveItem('{{ item.name }}')" 
                                    class="item-btn bg-gray-800 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition transform hover:scale-105 border border-gray-700 hover:border-green-400" data-name="{{ item.name }}" data-display="{{ item.display }}" data-category="{{ category|lower }}">
                                <div class="flex items-center justify-between">
                                    <span class="text-xl">{{ item.icon }}</span>
                                    {% if item.used_count %}
                                    <span class="text-[10px] bg-green-700 text-white px-2 py-0.5 rounded-full">{{ item.used_count }}x</span>
                                    {% endif %}
                                </div>
                                <div class="text-xs mt-1 text-left leading-tight">{{ item.display }}</div>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </form>
        </div>

        <!-- Quick Kits Section -->
        <div id="kits" class="glass rounded-xl shadow-2xl p-6 border border-purple-500/50 section-shell">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-box-open text-purple-400 mr-3"></i>
                Quick Kits
            </h2>
            
            <form id="kitForm">
                <div class="mb-4">
                    <label class="block text-purple-300 font-semibold mb-2">
                        <i class="fas fa-user"></i> Player
                    </label>
                    <select name="player" required class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-purple-500 focus:border-purple-400 focus:ring-2 focus:ring-purple-400 focus:outline-none">
                        {% if players|length == 0 %}
                        <option value="">No players online</option>
                        {% elif players|length == 1 %}
                        <option value="{{ players[0] }}" selected>{{ players[0] }} (Auto-selected)</option>
                        {% else %}
                        <option value="">Select Player</option>
                        {% for player in players %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    {% for kit in kits %}
                    <button type="button" onclick="giveKit('{{ kit.id }}')" 
                            class="bg-gradient-to-br from-{{ kit.color }}-600 to-{{ kit.color }}-700 hover:from-{{ kit.color }}-500 hover:to-{{ kit.color }}-600 text-white px-4 py-3 rounded-lg font-semibold transition transform hover:scale-105 shadow-lg"
                            title="{{ kit.description }}">
                        <i class="fas fa-{{ kit.icon }} text-xl mb-1"></i>
                        <div class="text-sm">{{ kit.name }}</div>
                    </button>
                    {% endfor %}
                </div>
            </form>
        </div>
    </div>

    <!-- Right Column: Teleport & Villages -->
    <div class="space-y-6">
        
        <!-- Teleport Section -->
        <div id="teleport" class="glass rounded-xl shadow-2xl p-6 border border-blue-500/50 section-shell">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-location-arrow text-blue-400 mr-3"></i>
                Teleport
            </h2>
            
            <form id="teleportForm" class="space-y-4">
                <div>
                    <label class="block text-blue-300 font-semibold mb-2">
                        <i class="fas fa-user"></i> Player
                    </label>
                    <select name="player" required class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-blue-500 focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:outline-none">
                        {% if players|length == 0 %}
                        <option value="">No players online</option>
                        {% elif players|length == 1 %}
                        <option value="{{ players[0] }}" selected>{{ players[0] }} (Auto-selected)</option>
                        {% else %}
                        <option value="">Select Player</option>
                        {% for player in players %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div>
                    <label class="block text-blue-300 font-semibold mb-2">
                        <i class="fas fa-map-marker-alt"></i> Preset Locations
                    </label>
                    <div id="locationsList" class="space-y-2"></div>
                </div>

                <div class="pt-4 mt-4 border-t border-blue-800">
                    <label class="block text-blue-300 font-semibold mb-3">
                        <i class="fas fa-crosshairs"></i> Direct Coordinates
                    </label>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <input name="x" type="number" placeholder="X" class="w-full px-3 py-2 bg-gray-800 text-white rounded-lg border border-blue-500 focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:outline-none">
                        <input name="y" type="number" placeholder="Y" class="w-full px-3 py-2 bg-gray-800 text-white rounded-lg border border-blue-500 focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:outline-none">
                        <input name="z" type="number" placeholder="Z" class="w-full px-3 py-2 bg-gray-800 text-white rounded-lg border border-blue-500 focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:outline-none">
                    </div>
                    <button type="button" onclick="teleportToCoords()" class="w-full bg-blue-600 hover:bg-blue-500 text-white px-4 py-3 rounded-lg font-semibold transition transform hover:scale-105 shadow-lg">
                        <i class="fas fa-location-crosshairs mr-2"></i> Teleport to Coordinates
                    </button>
                </div>
            </form>
        </div>

        <!-- Find Villages Section -->
        <div id="villages" class="glass rounded-xl shadow-2xl p-6 border border-orange-500/50 section-shell">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-compass text-orange-400 mr-3"></i>
                Find Villages
            </h2>
            
            <form id="locateForm" class="space-y-4">
                <div>
                    <label class="block text-orange-300 font-semibold mb-2">
                        <i class="fas fa-user"></i> Player
                    </label>
                    <select name="player" required class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-orange-500 focus:border-orange-400 focus:ring-2 focus:ring-orange-400 focus:outline-none">
                        {% if players|length == 0 %}
                        <option value="">No players online</option>
                        {% elif players|length == 1 %}
                        <option value="{{ players[0] }}" selected>{{ players[0] }} (Auto-selected)</option>
                        {% else %}
                        <option value="">Select Player</option>
                        {% for player in players %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div>
                    <label class="block text-orange-300 font-semibold mb-2">
                        <i class="fas fa-mountain"></i> Village Type
                    </label>
                    <div class="grid grid-cols-1 gap-2">
                        {% for vtype in village_types %}
                        <button type="button" onclick="locateVillage('{{ vtype }}')" class="bg-gray-800 hover:bg-orange-600 text-white px-4 py-3 rounded-lg transition text-left border border-gray-700 hover:border-orange-400">
                            <i class="fas fa-{{ 'tree' if vtype == 'taiga' else 'sun' if vtype == 'desert' else 'cloud-sun' if vtype == 'plains' else 'snowflake' if vtype == 'snowy' else 'leaf' }} mr-2"></i>
                            {{ vtype.title() }} Village
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </form>

            <div id="locationResult" class="mt-4 hidden">
                <div class="bg-green-900 bg-opacity-50 border border-green-500 rounded-lg p-4">
                    <p class="text-green-200 font-mono" id="locationText"></p>
                </div>
            </div>

        </div>

        <!-- Manage Locations Section -->
        <div id="locations" class="glass rounded-xl shadow-2xl p-6 border border-teal-500/50 section-shell">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-map-marked-alt text-teal-300 mr-3"></i>
                Manage Locations
            </h2>

            <div class="mb-4 p-3 bg-gray-900 bg-opacity-50 border border-teal-600 rounded-lg">
                <h3 class="text-sm font-semibold text-teal-200 mb-2 flex items-center"><i class="fas fa-crosshairs mr-2"></i>Capture Player Position</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <select id="capturePlayer" class="px-3 py-2 bg-gray-800 text-white rounded border border-teal-500">
                        {% if players|length == 0 %}
                        <option value="">No players online</option>
                        {% else %}
                        <option value="">Select player</option>
                        {% for player in players %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                    <input id="captureName" class="px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="Location name (e.g., Home Base)">
                    <button type="button" onclick="captureAndSaveLocation()" class="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 rounded font-semibold">Capture & Save</button>
                </div>
                <p class="text-xs text-teal-200 mt-2">Fetches the player's current coordinates and saves directly into presets.</p>
            </div>

            <form id="locationForm" class="space-y-3">
                <input type="hidden" name="mode" value="create">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">ID (slug)</label>
                        <input name="id" required class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="village3">
                    </div>
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">Name</label>
                        <input name="name" required class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="New Village">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">X</label>
                        <input name="x" type="number" required class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">Y</label>
                        <input name="y" type="number" required class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="64">
                    </div>
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">Z</label>
                        <input name="z" type="number" required class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="0">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">Icon (font-awesome, no fa-)</label>
                        <input name="icon" class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="home">
                    </div>
                    <div>
                        <label class="block text-teal-200 text-sm mb-1">Description</label>
                        <input name="description" class="w-full px-3 py-2 bg-gray-800 text-white rounded border border-teal-500" placeholder="Optional">
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <button type="submit" class="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 rounded font-semibold">Save</button>
                    <button type="button" id="cancelEdit" class="hidden bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded">Cancel edit</button>
                </div>
            </form>

            <div class="mt-4 space-y-2" id="manageLocationsList"></div>
        </div>

        <!-- Custom Command Section -->
        <div class="glass rounded-xl shadow-2xl p-6 border border-red-500/50 section-shell">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-terminal text-red-400 mr-3"></i>
                Custom Command
            </h2>
            
            <form id="commandForm" class="space-y-4">
                <div>
                    <label class="block text-red-300 font-semibold mb-2">
                        <i class="fas fa-user"></i> Player (optional)
                    </label>
                    <select name="player" class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-red-500 focus:border-red-400 focus:ring-2 focus:ring-red-400 focus:outline-none">
                        <option value="">No specific player</option>
                        {% for player in players %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-red-300 font-semibold mb-2">
                        <i class="fas fa-code"></i> Command
                    </label>
                    <input type="text" name="command" placeholder="/gamemode creative @p" class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-red-500 focus:border-red-400 focus:ring-2 focus:ring-red-400 focus:outline-none font-mono">
                </div>

                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105 shadow-lg">
                    <i class="fas fa-play"></i> Execute Command
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Give Item Function
    async function giveItem(itemName) {
        console.log('=== GIVE ITEM FUNCTION ===');
        const form = document.getElementById('giveItemForm');
        const player = form.player.value;
        const amount = form.amount.value;
        console.log('Player:', player);
        console.log('Item:', itemName);
        console.log('Amount:', amount);
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('item', itemName);
        formData.append('amount', amount);
        
        try {
            console.log('Sending give item request...');
            const response = await fetch('/give', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            console.log('Response:', data);
            if (data.success) {
                showNotification(`Gave ${amount}x ${itemName} to ${player}`);
            } else {
                showNotification('Failed to give item', 'error');
            }
        } catch (error) {
            console.error('Give item error:', error);
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Give Kit Function
    async function giveKit(kitName) {
        console.log('=== GIVE KIT FUNCTION ===');
        const form = document.getElementById('kitForm');
        const player = form.player.value;
        console.log('Player:', player);
        console.log('Kit:', kitName);
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        
        try {
            console.log('Sending give kit request...');
            const response = await fetch(`/kit/${kitName}`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            console.log('Response:', data);
            if (data.success) {
                showNotification(`Gave ${kitName} kit to ${player}`);
            } else {
                showNotification('Failed to give kit', 'error');
            }
        } catch (error) {
            console.error('Give kit error:', error);
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Quick Command Function
    async function quickCommand(commandType) {
        console.log('=== QUICK COMMAND FUNCTION ===');
        const playerSelect = document.getElementById('quickCommandPlayer');
        const player = playerSelect ? playerSelect.value : document.querySelector('#quickCommandForm select[name=\"player\"]')?.value;
        console.log('Player:', player);
        console.log('Command Type:', commandType);
        
        // Some commands don't require player selection
        const noPlayerCommands = [
            'day', 'night', 'clear_weather', 'rain', 'thunder',
            'difficulty_peaceful', 'difficulty_normal', 'difficulty_hard',
            'keep_inventory_on', 'keep_inventory_off',
            'mob_griefing_off', 'mob_griefing_on',
            'daylight_cycle_off', 'daylight_cycle_on',
            'worldborder_small', 'worldborder_medium', 'worldborder_large', 'worldborder_infinite',
            'clear_ground_items', 'spawn_villager_librarian', 'spawn_iron_golem'
        ];
        
        if (!player && !noPlayerCommands.includes(commandType)) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('command_type', commandType);
        
        try {
            console.log('Sending quick command request...');
            const response = await fetch('/quick-command', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            console.log('Response:', data);
            if (data.success) {
                showNotification(`Command executed: ${commandType.replace('_', ' ')}`);
            } else {
                showNotification('Failed to execute command', 'error');
            }
        } catch (error) {
            console.error('Quick command error:', error);
            showNotification('Error: ' + error.message, 'error');
        }
    }
    // Teleport Function
    async function teleportTo(locationId) {
        console.log('=== TELEPORT FUNCTION ===');
        const form = document.getElementById('teleportForm');
        const player = form.player.value;
        console.log('Player:', player);
        console.log('Location ID:', locationId);
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('location_id', locationId);
        
        try {
            console.log('Sending teleport request...');
            const response = await fetch('/tp', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            console.log('Response:', data);
            if (data.success) {
                showNotification(`Teleported ${player} to ${locationId}`);
            } else {
                showNotification('Failed to teleport', 'error');
            }
        } catch (error) {
            console.error('Teleport error:', error);
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Teleport to direct coordinates
    async function teleportToCoords() {
        const form = document.getElementById('teleportForm');
        const player = form.player.value;
        const x = form.querySelector('input[name="x"]').value;
        const y = form.querySelector('input[name="y"]').value;
        const z = form.querySelector('input[name="z"]').value;

        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        if (x === '' || y === '' || z === '') {
            showNotification('Enter X, Y, and Z coordinates', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('player', player);
        formData.append('x', x);
        formData.append('y', y);
        formData.append('z', z);

        try {
            const response = await fetch('/tp/coordinates', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification(`Teleported ${player} to ${x}, ${y}, ${z}`);
            } else {
                showNotification(data.error || 'Failed to teleport', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // Locate Village Function
    async function locateVillage(villageType) {
        const form = document.getElementById('locateForm');
        const player = form.player.value;
        
        if (!player) {
            showNotification('Please select a player', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('player', player);
        formData.append('village_type', villageType);
        
        try {
            const response = await fetch('/locate', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification(`Finding ${villageType} village for ${player}`);
                document.getElementById('locationResult').classList.remove('hidden');
                document.getElementById('locationText').textContent = data.result;
            } else {
                showNotification('Failed to locate village', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    // ---- Locations (DB-backed) ----
    let editingLocationId = null;

    async function loadLocations() {
        const list = document.getElementById('locationsList');
        const manageList = document.getElementById('manageLocationsList');
        list.innerHTML = '<div class="text-gray-400 text-sm">Loading...</div>';
        manageList.innerHTML = '';
        try {
            const res = await fetch('/api/locations');
            const data = await res.json();
            const locations = data.locations || [];

            if (!locations.length) {
                list.innerHTML = '<div class="text-gray-400 text-sm">No locations saved.</div>';
                manageList.innerHTML = '<div class="text-gray-400 text-sm">No locations yet.</div>';
                return;
            }

            list.innerHTML = locations.map(loc => `
                <button type="button" onclick="teleportTo('${loc.id}')"
                        class="w-full bg-gray-800 hover:bg-blue-600 text-white px-4 py-3 rounded-lg transition text-left border border-gray-700 hover:border-blue-400"
                        title="${loc.description || ''}">
                    <i class="fas fa-${loc.icon || 'map-marker-alt'} mr-2"></i>
                    ${loc.name} (${loc.coordinates.x}, ${loc.coordinates.y}, ${loc.coordinates.z})
                </button>
            `).join('');

            manageList.innerHTML = locations.map(loc => `
                <div class="flex items-center justify-between bg-gray-900 bg-opacity-60 border border-gray-700 rounded-lg px-3 py-2">
                    <div class="text-sm text-white">
                        <div class="font-semibold">${loc.name} <span class="text-gray-400">(${loc.id})</span></div>
                        <div class="text-gray-300">${loc.coordinates.x}, ${loc.coordinates.y}, ${loc.coordinates.z}</div>
                        <div class="text-gray-400 text-xs">${loc.description || ''}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs" data-action="edit" data-id="${loc.id}">Edit</button>
                        <button class="bg-red-700 hover:bg-red-600 text-white px-3 py-1 rounded text-xs" data-action="delete" data-id="${loc.id}">Delete</button>
                    </div>
                </div>
            `).join('');

            attachManageHandlers(locations);
        } catch (err) {
            list.innerHTML = '<div class="text-red-400 text-sm">Failed to load locations</div>';
            manageList.innerHTML = '<div class="text-red-400 text-sm">Failed to load locations</div>';
        }
    }

    function attachManageHandlers(locations) {
        const manageList = document.getElementById('manageLocationsList');
        manageList.querySelectorAll('[data-action="edit"]').forEach(btn => {
            const id = btn.dataset.id;
            const loc = locations.find(l => l.id === id);
            btn.onclick = () => startEditLocation(loc);
        });
        manageList.querySelectorAll('[data-action="delete"]').forEach(btn => {
            const id = btn.dataset.id;
            btn.onclick = () => deleteLocation(id);
        });
    }

    function startEditLocation(loc) {
        editingLocationId = loc.id;
        const form = document.getElementById('locationForm');
        form.mode.value = 'edit';
        form.id.value = loc.id;
        form.id.disabled = true;
        form.name.value = loc.name;
        form.icon.value = loc.icon || '';
        form.description.value = loc.description || '';
        form.x.value = loc.coordinates.x;
        form.y.value = loc.coordinates.y;
        form.z.value = loc.coordinates.z;
        document.getElementById('cancelEdit').classList.remove('hidden');
    }

    async function deleteLocation(id) {
        if (!confirm('Delete location ' + id + '?')) return;
        await fetch(`/api/locations/${id}`, { method: 'DELETE' });
        if (editingLocationId === id) resetLocationForm();
        loadLocations();
        showNotification('Location deleted');
    }

    function resetLocationForm() {
        const form = document.getElementById('locationForm');
        form.reset();
        form.mode.value = 'create';
        form.id.disabled = false;
        editingLocationId = null;
        document.getElementById('cancelEdit').classList.add('hidden');
    }

    document.getElementById('cancelEdit').addEventListener('click', resetLocationForm);

    document.getElementById('locationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const payload = {
            id: formData.get('id'),
            name: formData.get('name'),
            icon: formData.get('icon'),
            description: formData.get('description'),
            x: formData.get('x'),
            y: formData.get('y'),
            z: formData.get('z'),
        };

        const method = form.mode.value === 'edit' ? 'PUT' : 'POST';
        const url = form.mode.value === 'edit' ? `/api/locations/${editingLocationId}` : '/api/locations';

        try {
            const res = await fetch(url, { method, body: toFormData(payload) });
            const data = await res.json();
            if (data.success) {
                showNotification('Location saved');
                resetLocationForm();
                loadLocations();
            } else {
                showNotification(data.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showNotification('Failed to save location', 'error');
        }
    });

    function toFormData(obj) {
        const fd = new FormData();
        Object.entries(obj).forEach(([k, v]) => fd.append(k, v));
        return fd;
    }

    const QA_STORAGE_KEY_DASH = 'qaState-dashboard';

    function setQuickAccessState(open) {
        const panel = document.getElementById('quickAccessNav');
        const shell = document.getElementById('pageShell');
        if (!panel || !shell) return;

        if (open) {
            panel.classList.remove('hidden', 'lg:hidden');
            panel.classList.add('lg:block');
            if (window.innerWidth >= 1024) {
                shell.classList.add('lg:pl-64');
                shell.classList.remove('lg:pl-6');
            }
        } else {
            panel.classList.add('hidden', 'lg:hidden');
            panel.classList.remove('lg:block');
            if (window.innerWidth >= 1024) {
                shell.classList.remove('lg:pl-64');
                shell.classList.add('lg:pl-6');
            }
        }
        localStorage.setItem(QA_STORAGE_KEY_DASH, open ? 'open' : 'closed');
    }

    function toggleQuickAccess() {
        const saved = localStorage.getItem(QA_STORAGE_KEY_DASH);
        const currentlyOpen = saved ? saved === 'open' : true;
        setQuickAccessState(!currentlyOpen);
    }

    function restoreQuickAccessState() {
        const saved = localStorage.getItem(QA_STORAGE_KEY_DASH);
        const shouldOpen = saved ? saved === 'open' : true;
        setQuickAccessState(shouldOpen);
    }

    function setGamemode(mode) {
        const player = document.getElementById('topPlayerSelect').value;
        if (!player) {
            showNotification('Select a player first', 'error');
            return;
        }
        const fd = new FormData();
        fd.append('player', player);
        fd.append('command_type', mode);
        fetch('/quick-command', { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const label = mode === 'gamemode_creative' ? 'Creative' : 'Survival';
                    showNotification(`${player} set to ${label}`);
                } else {
                    showNotification(data.error || 'Failed to change mode', 'error');
                }
            })
            .catch(err => showNotification('Error: ' + err.message, 'error'));
    }

    // Item filter UX
    const itemFilterInput = document.getElementById('itemFilter');
    if (itemFilterInput) {
        itemFilterInput.addEventListener('input', () => {
            const query = itemFilterInput.value.toLowerCase();
            document.querySelectorAll('.category-block').forEach(block => {
                let visibleCount = 0;
                block.querySelectorAll('.item-btn').forEach(btn => {
                    const text = `${btn.dataset.name} ${btn.dataset.display} ${btn.dataset.category}`.toLowerCase();
                    const show = text.includes(query);
                    btn.classList.toggle('hidden', !show);
                    if (show) visibleCount += 1;
                });
                block.classList.toggle('hidden', visibleCount === 0 && query.length > 0);
            });
        });
    }

    function slugifyName(name) {
        const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        return slug || `loc-${Date.now()}`;
    }

    async function captureAndSaveLocation() {
        const player = document.getElementById('capturePlayer').value;
        const name = document.getElementById('captureName').value.trim();

        if (!player) {
            showNotification('Select a player to capture position', 'error');
            return;
        }
        if (!name) {
            showNotification('Enter a name for the location', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('player', player);

        try {
            const posRes = await fetch('/api/player-location', { method: 'POST', body: formData });
            const posData = await posRes.json();
            if (!posData.success) {
                showNotification(posData.error || 'Failed to fetch position', 'error');
                return;
            }

            const coords = posData.coordinates;
            const payload = {
                id: slugifyName(name),
                name,
                icon: 'map-marker-alt',
                description: '',
                x: coords.x,
                y: coords.y,
                z: coords.z,
            };

            const saveRes = await fetch('/api/locations', { method: 'POST', body: toFormData(payload) });
            const saveData = await saveRes.json();
            if (saveData.success) {
                showNotification('Location saved');
                document.getElementById('captureName').value = '';
                loadLocations();
            } else {
                showNotification(saveData.error || 'Failed to save location', 'error');
            }
        } catch (err) {
            showNotification('Error capturing location: ' + err.message, 'error');
        }
    }

    // Initial loads
    restoreQuickAccessState();
    loadLocations();

    // Custom Command Form
    document.getElementById('commandForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        try {
            const response = await fetch('/command', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification('Command executed successfully');
                e.target.command.value = '';
            } else {
                showNotification('Failed to execute command', 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    });
</script>
</div>
{% endblock %}
